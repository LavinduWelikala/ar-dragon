<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Drogon AR Scene</title>
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <!-- A-Frame extras for animation-mixer -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <!-- Start button overlay for audio context -->
    <div id="startButton" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 999; cursor: pointer;">
      <div style="background-color: #4CAF50; color: white; padding: 20px 40px; border-radius: 8px; font-family: Arial; font-size: 24px;">
        TAP TO START AR EXPERIENCE
      </div>
    </div>

    <audio id="roar-audio" src="roar.mp3" preload="auto"></audio>
    
    <a-scene embedded arjs="debugUIEnabled: false;">
      <a-assets>
        <!-- GLTF Model -->
        <a-asset-item id="gltf-model" src="scene.gltf"></a-asset-item>
      </a-assets>
      
      <!-- Marker and Model -->
      <a-marker preset="hiro" id="marker">
        <a-entity
          id="dragon-model"
          gltf-model="#gltf-model"
          position="0 0.2 0"
          rotation="0 180 0"
          scale="0.1 0.1 0.1"
          animation-mixer="loop: repeat; clampWhenFinished: true">
        </a-entity>
      </a-marker>
      
      <!-- Camera -->
      <a-entity camera></a-entity>
    </a-scene>
    
    <script>
      // Debug info display
      const debugInfo = document.createElement("div");
      debugInfo.style.position = "fixed";
      debugInfo.style.bottom = "10px";
      debugInfo.style.left = "10px";
      debugInfo.style.backgroundColor = "rgba(0,0,0,0.7)";
      debugInfo.style.color = "white";
      debugInfo.style.padding = "10px";
      debugInfo.style.fontFamily = "monospace";
      debugInfo.style.zIndex = "999";
      document.body.appendChild(debugInfo);
      
      // Audio element
      const roarAudio = document.getElementById("roar-audio");
      
      // Get references to elements
      const marker = document.querySelector("#marker");
      const dragon = document.querySelector("#dragon-model");
      const startButton = document.getElementById("startButton");
      
      // Variables to track state
      let audioContext = null;
      let isMarkerVisible = false;
      let audioInitialized = false;
      
      // Initialize audio on user interaction
      startButton.addEventListener("click", () => {
        // Create and resume AudioContext
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === "suspended") {
          audioContext.resume();
        }
        
        // Hide the start button
        startButton.style.display = "none";
        
        // Set flag
        audioInitialized = true;
        
        // If marker is already visible, play sound
        if (isMarkerVisible) {
          playSound();
        }
        
        debugInfo.textContent = "Audio initialized. Ready for marker detection.";
      });
      
      // Function to play sound
      function playSound() {
        if (!audioInitialized) return;
        
        // Reset and play
        roarAudio.currentTime = 0;
        roarAudio.play().catch(e => {
          debugInfo.textContent = `Sound error: ${e.message}`;
        });
      }
      
      // Function to stop sound
      function stopSound() {
        roarAudio.pause();
        roarAudio.currentTime = 0;
      }
      
      // Marker detection events
      marker.addEventListener("markerFound", () => {
        isMarkerVisible = true;
        debugInfo.textContent = "Marker found! Animation should be playing.";
        
        // Play sound if audio is initialized
        if (audioInitialized) {
          playSound();
        }
        
        // Make sure animation is playing
        if (dragon.components && dragon.components["animation-mixer"]) {
          dragon.components["animation-mixer"].play();
          debugInfo.textContent += " Animation mixer is playing.";
        } else {
          debugInfo.textContent += " Animation mixer component not found!";
        }
      });
      
      marker.addEventListener("markerLost", () => {
        isMarkerVisible = false;
        debugInfo.textContent = "Marker lost. Animation paused.";
        
        // Stop sound
        stopSound();
        
        // Optionally pause animation when marker is lost
        if (dragon.components && dragon.components["animation-mixer"]) {
          dragon.components["animation-mixer"].pause();
        }
      });
      
      // Check if the model has animations
      dragon.addEventListener("model-loaded", (e) => {
        const model = e.detail.model;
        if (model && model.animations && model.animations.length > 0) {
          debugInfo.textContent = `Model loaded with ${model.animations.length} animations`;
          
          // If you want to play a specific animation
          if (model.animations.length > 1) {
            dragon.setAttribute("animation-mixer", {
              clip: model.animations[0].name,
              loop: "repeat"
            });
          }
        } else {
          debugInfo.textContent = "Model loaded but has no animations!";
        }
      });
    </script>
  </body>
</html>